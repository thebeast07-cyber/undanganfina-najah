(()=>{var r=(()=>{let a='<span class="spinner-border spinner-border-sm my-0 ms-0 me-1 p-0" style="height: 0.8rem; width: 0.8rem;"></span>',p=[["*",'<strong class="text-theme-auto">$1</strong>'],["_",'<em class="text-theme-auto">$1</em>'],["~",'<del class="text-theme-auto">$1</del>'],["```",'<code class="font-monospace text-theme-auto">$1</code>']],w=[{type:"Mobile",regex:/Android.*Mobile|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i},{type:"Tablet",regex:/iPad|Android(?!.*Mobile)|Tablet/i},{type:"Desktop",regex:/Windows NT|Macintosh|Linux/i}],h=[{name:"Chrome",regex:/Chrome|CriOS/i},{name:"Safari",regex:/Safari/i},{name:"Edge",regex:/Edg|Edge/i},{name:"Firefox",regex:/Firefox|FxiOS/i},{name:"Opera",regex:/Opera|OPR/i},{name:"Internet Explorer",regex:/MSIE|Trident/i},{name:"Samsung Browser",regex:/SamsungBrowser/i}],T=[{name:"Windows",regex:/Windows NT ([\d.]+)/i},{name:"MacOS",regex:/Mac OS X ([\d_.]+)/i},{name:"Android",regex:/Android ([\d.]+)/i},{name:"iOS",regex:/OS ([\d_]+) like Mac OS X/i},{name:"Linux",regex:/Linux/i},{name:"Ubuntu",regex:/Ubuntu/i},{name:"Chrome OS",regex:/CrOS/i}],l=s=>String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),i=s=>{let u=e=>{window.alert(`${e} ${s}`)};return{success:()=>u("\u{1F7E9}"),error:()=>u("\u{1F7E5}"),warning:()=>u("\u{1F7E8}"),info:()=>u("\u{1F7E6}"),custom:e=>u(e)}},k=s=>window.confirm(`\u{1F7E6} ${s}`),E=(s,u)=>(s.replaceChildren(document.createRange().createContextualFragment(u)),s),x=(s,u,e=.05)=>new Promise(t=>{let o=parseFloat(s.style.opacity),g=u?1:0,c=()=>{o+=u?e:-e,o=Math.max(0,Math.min(1,o)),s.style.opacity=o.toFixed(2),u&&o>=g||!u&&o<=g?(s.style.opacity=g.toString(),t(s)):requestAnimationFrame(c)};requestAnimationFrame(c)}),n=(s,u=0)=>{let e=null;e=setTimeout(()=>{s(),clearTimeout(e),e=null},u)};return{loader:a,ask:k,copy:async(s,u=null,e=1500)=>{let t=s.getAttribute("data-copy");if(!t||t.length===0){i("Nothing to copy").warning();return}s.disabled=!0;try{await navigator.clipboard.writeText(t)}catch{s.disabled=!1,i("Failed to copy").error();return}let o=s.innerHTML;E(s,u||'<i class="fa-solid fa-check"></i>'),n(()=>{s.disabled=!1,s.innerHTML=o},e)},notify:i,timeOut:n,debounce:(s,u=100)=>{let e=null;return(...t)=>{clearTimeout(e),e=setTimeout(()=>s(...t),u)}},escapeHtml:l,base64Encode:s=>{let e=new TextEncoder().encode(s);return window.btoa(String.fromCharCode(...e))},base64Decode:s=>{let u=new TextDecoder,e=Uint8Array.from(window.atob(s),t=>t.charCodeAt(0));return u.decode(e)},disableButton:(s,u="Loading",e=!1)=>{s.disabled=!0;let t=s.innerHTML;return E(s,e?u:a+u),{restore:(o=!1)=>{s.innerHTML=t,s.disabled=o}}},disableCheckbox:s=>{s.disabled=!0;let u=document.querySelector(`label[for="${s.id}"]`),e=u.innerHTML;return E(u,a+e),{restore:()=>{u.innerHTML=e,s.disabled=!1}}},safeInnerHTML:E,parseUserAgent:s=>{if(!s||typeof s!="string")return"Unknown";let u=w.find(c=>c.regex.test(s))?.type??"Unknown",e=h.find(c=>c.regex.test(s))?.name??"Unknown",t=T.find(c=>c.regex.test(s)),o=t?t.name:"Unknown",g=t?s.match(t.regex)?.[1]?.replace(/_/g,".")??null:null;return`${e} ${u} ${g?`${o} ${g}`:o}`},changeOpacity:x,getGMTOffset:s=>{let u=new Date,e=new Intl.DateTimeFormat("en-US",{timeZone:s,hourCycle:"h23",hour:"numeric"}),t=(parseInt(e.format(u))-u.getUTCHours()+24)%24;return t>12&&(t-=24),`GMT${t>=0?"+":""}${t}`},convertMarkdownToHTML:s=>(p.forEach(([u,e])=>{s=s.replace(new RegExp(`\\${u}(\\S(?:[\\s\\S]*?\\S)?)\\${u}`,"g"),e)}),s),generateUUID:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(s){let u=Math.random()*16|0;return(s=="x"?u:u&3|8).toString(16)}),nl2br:s=>typeof s!="string"?"":s.replace(/(?:\r\n|\r|\n)/g,"<br>"),formatText:s=>{let u=s;return u=u.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),u=u.replace(/_(.*?)_/g,"<em>$1</em>"),u=u.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'),u}}})();var H={tab:w=>window.bootstrap.Tab.getOrCreateInstance(document.getElementById(w)),modal:w=>window.bootstrap.Modal.getOrCreateInstance(document.getElementById(w))};var B=a=>{let p=(i=null)=>{let k=JSON.parse(localStorage.getItem(a));return i?k[String(i)]:k},w=(i,k)=>{let E=p();E[String(i)]=k,localStorage.setItem(a,JSON.stringify(E))},h=i=>Object.keys(p()).includes(String(i)),T=i=>{if(!h(i))return;let k=p();delete k[String(i)],localStorage.setItem(a,JSON.stringify(k))},l=()=>localStorage.setItem(a,"{}");return localStorage.getItem(a)||l(),{set:w,get:p,has:h,clear:l,unset:T}};var D=(()=>{let a=null,p=i=>{let k=r.disableButton(i),E=document.getElementById("loginEmail"),x=document.getElementById("loginPassword");E.disabled=!0,x.disabled=!0;let n=E.value,d=x.value;firebase.auth().signInWithEmailAndPassword(n,d).then(v=>{let C=v.user;console.log("Admin Auth: Login berhasil!",C),r.notify("Login berhasil!").success(),E.value="",x.value="",H.modal("mainModal").hide()}).catch(v=>{let C=v.code,m=v.message;console.error("Admin Auth: Login gagal!",C,m),r.notify(`Login gagal: ${m}`).error()}).finally(()=>{k.restore(),E.disabled=!1,x.disabled=!1})},w=async()=>{await firebase.auth().signOut().then(()=>{console.log("Admin Auth: Logout berhasil."),a?.clear(),r.notify("Logout berhasil.").info(),H.modal("mainModal").show()}).catch(i=>{console.error("Admin Auth: Error saat logout:",i),r.notify(`Logout gagal: ${i.message}`).error()})};return{init:()=>{a=B("user")},login:p,clearSession:w,getDetailUser:async()=>{let i=firebase.auth().currentUser;if(!i)throw console.warn("Admin Auth: Tidak ada user yang sedang login."),new Error("No user logged in.");console.log("Admin Auth: User sedang login:",i.uid,i.email);let E=(await i.getIdTokenResult(!0)).claims.admin===!0;if(console.log("Admin Auth: isAdmin (from claim):",E),!E)throw console.warn("Admin Auth: User bukan admin. Logout."),await w(),new Error("Not authorized as admin.");try{let n=await db.collection("adminSettings").doc(i.uid).get();if(n.exists){let d=n.data();return console.log("Admin Auth: Data admin dari Firestore:",d),Object.entries(d).forEach(([v,C])=>a.set(v,C)),a.set("uid",i.uid),a.set("email",i.email),a.set("name",d.name||i.email),{code:200,data:a.get(),error:null}}else throw console.warn("Admin Auth: Dokumen setting admin tidak ditemukan di Firestore untuk UID ini."),new Error("Admin settings not found. Please setup admin profile.")}catch(x){throw console.error("Admin Auth: Error fetching admin settings from Firestore:",x),x}},getUserStorage:()=>a}})();var j=(()=>{let a=(h,T)=>{document.querySelectorAll(".navbar button").forEach(l=>{l.classList.contains("active")&&l.classList.remove("active")}),H.tab(T).show(),h.classList.add("active")};return{buttonNavHome:h=>{a(h,"button-home")},buttonNavSetting:h=>{a(h,"button-setting")}}})();var N=(()=>{let a=n=>{let d=n.uuid,v=n.own??"false",C=n.name,m=typeof n.presence=="boolean"?n.presence:n.presence==="1",f=n.commentText,A=n.created_at,S=n.is_admin??!1,y=n.is_parent??!0,I=n.gif||null,_=n.ip||null,U=n.user_agent||null,O=n.like??0,s=n.parentId??null;return{uuid:d,own:v,name:C,presence:m,comment:f,created_at:A?new Date(A.toDate?A.toDate():A).toLocaleString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}):"Baru saja",is_admin:S,is_parent:y,gif_url:I,ip:_,user_agent:U,comments:[],like_count:O,parentId:s}},p=n=>n.map(a);return{uuidResponse:({uuid:n})=>({uuid:n}),tokenResponse:({token:n})=>({token:n}),statusResponse:({status:n})=>({status:n}),getCommentResponse:a,getCommentsResponse:p,getCommentsResponseV2:n=>({count:n.count,lists:p(n.lists)}),commentShowMore:(n,d=!1)=>({uuid:n,show:d}),postCommentRequest:(n,d,v,C,m)=>{let f={name:d,presence:v,created_at:firebase.firestore.FieldValue.serverTimestamp(),like:0,is_admin:!1,is_parent:!n};return C&&(f.commentText=C),m&&(f.gif=m),n?f.parentId=n:f.parentId=null,f},postSessionRequest:(n,d)=>({email:n,password:d}),updateCommentRequest:(n,d,v)=>{let C={};return n!==null&&(C.presence=n),d!==null&&(C.commentText=d),v!==null&&(C.gif=v),v===""&&(C.gif=firebase.firestore.FieldValue.delete()),C}}})();var F=(()=>{let a={"#000000":"#ffffff","#ffffff":"#000000","#212529":"#f8f9fa","#f8f9fa":"#212529"},p=["#ffffff","#f8f9fa"],w=["#000000","#212529"],h=!1,T=null,l=null,i=()=>T.set("active","light"),k=()=>T.set("active","dark"),E=A=>{let S=l.getAttribute("content");l.setAttribute("content",A.some(y=>y===S)?a[S]:S)},x=()=>{i(),document.documentElement.setAttribute("data-bs-theme","light"),E(w)},n=()=>{k(),document.documentElement.setAttribute("data-bs-theme","dark"),E(p)},d=(A=null,S=null)=>{let y=T.get("active")==="dark";return A&&S?y?A:S:y};return{init:()=>{switch(T=B("theme"),l=document.querySelector('meta[name="theme-color"]'),T.has("active")||(window.matchMedia("(prefers-color-scheme: dark)").matches?k():i()),document.documentElement.getAttribute("data-bs-theme")){case"dark":k();break;case"light":i();break;default:h=!0}d()?n():x()},spyTop:()=>{let A=y=>y.filter(I=>I.isIntersecting).forEach(I=>{let _=I.target.classList.contains("bg-white-black")?d(w[0],p[0]):d(w[1],p[1]);l.setAttribute("content",_)}),S=new IntersectionObserver(A,{rootMargin:"0% 0% -95% 0%"});document.querySelectorAll("section").forEach(y=>S.observe(y))},change:()=>d()?x():n(),isDarkMode:d,isAutoMode:()=>h}})();var z=(()=>{let a={id:"ID",en:"US",fr:"FR",de:"DE",es:"ES",zh:"CN",ja:"JP",ko:"KR",ar:"SA",ru:"RU",it:"IT",nl:"NL",pt:"PT",tr:"TR",th:"TH",vi:"VN",ms:"MY",hi:"IN"},p=null,w=null,h=null,T=null;return{on(l,i){return T.set(l,i),this},get(){let l=T.get(h);return T.clear(),l},getCountry(){return p},getLocale(){return w},getLanguage(){return h},setDefault(l){let i=!0;a[l]||(i=!1,console.warn("Language not found, please add manually in countryMapping")),p=i?a[l]:"US",h=i?l:"en",w=`${h}_${p}`},init(){T=new Map,this.setDefault(navigator.language.split("-").shift())}}})();var G="GET";var Z="POST";var J="AbortError",ae="TypeError",W={Accept:"application/json","Content-Type":"application/json"},se="request",re=(()=>{let a=null;return{getInstance:()=>(a||(a=window.caches.open(se)),a),purge:()=>{a=null}}})();var ie=a=>({set:(T,l,i,k)=>l.clone().arrayBuffer().then(E=>{if(!l.ok||!window.isSecureContext)return l;let x=new Date,n=new Headers(l.headers);if(n.has("Date")||n.set("Date",x.toUTCString()),i||!n.has("Cache-Control")){if(!i&&n.has("Expires")){let d=new Date(n.get("Expires"));k=Math.max(0,d.getTime()-x.getTime())}n.set("Cache-Control",`public, max-age=${Math.floor(k/1e3)}`)}return n.has("Content-Length")||n.set("Content-Length",String(E.byteLength)),a.put(T,new Response(E,{headers:n})).then(()=>l)}),has:T=>a.match(T).then(l=>{if(!l)return null;let i=l.headers.get("Cache-Control").match(/max-age=(\d+)/)[1],k=Date.parse(l.headers.get("Date"))+parseInt(i)*1e3;return Date.now()>k?null:l}),del:T=>a.delete(T)}),K=(a,p)=>{let w=new AbortController,h={signal:w.signal,credential:"include",headers:new Headers(W),method:String(a).toUpperCase()};window.addEventListener("offline",()=>w.abort(),{once:!0}),window.addEventListener("popstate",()=>w.abort(),{once:!0});let T=0,l=0,i=0,k=0,E=!1,x=null,n=null,d=null,v=m=>{let f=()=>{let S=()=>window.fetch(m,h).then(async y=>{if(!y.ok||!d)return y;let I=parseInt(y.headers.get("Content-Length")??0);if(I===0)return y;let _=[],U=0,O=y.body.getReader();for(;;){let{done:u,value:e}=await O.read();if(u)break;_.push(e),U+=e.length,await d(U,I,window.structuredClone?window.structuredClone(_):_)}let s=y.headers.get("Content-Type")??"application/octet-stream";return new Response(new Blob(_,{type:s}),{status:y.status,statusText:y.statusText,headers:new Headers(y.headers)})});return T===0||!window.isSecureContext?S():h.method!==G?(console.warn("Only method GET can be cached"),S()):re.getInstance().then(ie).then(y=>y.has(m).then(I=>I?Promise.resolve(I):y.del(m).then(S).then(_=>y.set(m,_,E,T))))};if(l===0&&i===0)return f();let A=async()=>{try{return await f()}catch(S){if(S.name===J)throw S;if(i*=2,k++,k>l)throw new Error(`Max retries reached: ${S}`);return console.warn(`Retrying fetch (${k}/${l}): ${m.toString()}`),await new Promise(y=>window.setTimeout(y,i)),A()}};return A()},C=m=>{if(m.status!==200)return m;let f=document.querySelector("a[download]");f&&document.body.removeChild(f);let A=m.headers.get("Content-Disposition")?.match(/filename="(.+)"/)?.[1];return m.clone().blob().then(S=>{let y=document.createElement("a"),I=window.URL.createObjectURL(S);return y.href=I,y.download=A||`${n}.${x||(S.type.split("/")?.[1]??"bin")}`,document.body.appendChild(y),y.click(),document.body.removeChild(y),window.URL.revokeObjectURL(I),m})};return{send(m=null){return n&&Object.keys(W).forEach(f=>h.headers.delete(f)),v(new URL(p,document.body.getAttribute("data-url"))).then(f=>n&&f.ok?{code:f.status,data:C(f),error:null}:f.json().then(A=>{if(A.error){let S=A.error.at(0),y=f.status>=500;throw new Error(y?`ID: ${A.id}
\u{1F7E5} ${S}`:`\u{1F7E8} ${S}`)}return m&&(A.data=m(A.data)),Object.assign(A,{code:f.status})})).catch(f=>{if(f.name===J)return console.warn("Fetch aborted:",f),f;throw f.name===ae&&(f=new Error("\u{1F7E5} Network error or rate limit exceeded")),alert(f.message||String(f)),f})},withCache(m=1e3*60*60*6){return T=m,this},withForceCache(){return E=!0,this},withRetry(m=3,f=1e3){return l=m,i=f,this},withCancel(m){return m==null?this:((async()=>(await m,w.abort()))(),this)},withDownload(m,f=null){return n=m,x=f,this},withProgressFunc(m=null){return d=m,this},default(m=null){return h.headers=new Headers(m??{}),v(p).then(f=>n?C(f):f)},token(m){return m.split(".").length===3?(h.headers.append("Authorization","Bearer "+m),this):(h.headers.append("x-access-key",m),this)},body(m){if(h.method===G)throw new Error("GET method does not support body");return h.body=JSON.stringify(m),this}}};var X=(()=>{let a=null,p=()=>a.get("token"),w=x=>a.set("token",x),h=x=>K(Z,"/api/session").body(x).send(N.tokenResponse).then(n=>(n.code===200&&w(n.data.token),n.code===200)),T=()=>a.unset("token"),l=()=>String(p()??".").split(".").length===3;return{init:()=>{a=B("session")},guest:x=>K(G,"/api/v2/config").withCache(1e3*60*30).withForceCache().token(x).send().then(n=>{if(n.code!==200)throw new Error("failed to get config.");let d=B("config");for(let[v,C]of Object.entries(n.data))d.set(v,C);return w(x),n}),login:h,logout:T,decode:()=>{if(!l())return null;try{return JSON.parse(r.base64Decode(p().split(".")[1]))}catch{return null}},isAdmin:l,setToken:w,getToken:p}})();var Y=(()=>{let a=null,p=!0,w=["input[data-offline-disabled]","button[data-offline-disabled]","select[data-offline-disabled]","textarea[data-offline-disabled]"],h=()=>p,T=()=>{let d=a.firstElementChild.firstElementChild;d.classList.remove("bg-success"),d.classList.add("bg-danger"),d.firstElementChild.innerHTML='<i class="fa-solid fa-ban me-2"></i>Koneksi tidak tersedia'},l=()=>{let d=a.firstElementChild.firstElementChild;d.classList.remove("bg-danger"),d.classList.add("bg-success"),d.firstElementChild.innerHTML='<i class="fa-solid fa-cloud me-2"></i>Koneksi tersedia kembali'},i=async()=>{p&&(await r.changeOpacity(a,!1),T())},k=()=>{document.querySelectorAll(w.join(", ")).forEach(d=>{d.dispatchEvent(new Event(h()?"online":"offline")),d.setAttribute("data-offline-disabled",h()?"false":"true"),d.tagName==="BUTTON"?h()?d.classList.remove("disabled"):d.classList.add("disabled"):h()?d.removeAttribute("disabled"):d.setAttribute("disabled","true")})},E=()=>{p=!1,T(),r.changeOpacity(a,!0),k()},x=()=>{p=!0,l(),r.timeOut(i,3e3),k()};return{init:()=>{window.addEventListener("online",x),window.addEventListener("offline",E),a=document.createElement("div"),a.classList.add("fixed-top","pe-none"),a.style.cssText="opacity: 0; z-index: 1057;",a.innerHTML=`
        <div class="d-flex justify-content-center mx-auto">
            <div class="d-flex justify-content-center align-items-center rounded-pill my-2 bg-danger shadow">
                <small class="text-center py-1 px-2 mx-1 mt-1 mb-0 text-white" style="font-size: 0.8rem;"></small>
            </div>
        </div>`,document.body.insertBefore(a,document.body.lastChild)},isOnline:h}})();var Q=(()=>{let a,p=db.collection("adminSettings").doc("main_app_settings"),w=null,h=null,T=10,l,i,k,E=()=>{r.ask("Apakah Anda yakin ingin logout?")&&D.clearSession()},x=e=>{let t=e.created_at||"",o=e.presence==="1"?'<i class="fa-solid fa-circle-check text-success ms-1"></i> Datang':e.presence==="2"?'<i class="fa-solid fa-circle-xmark text-danger ms-1"></i> Berhalangan':"",g=e.gif_url?`<img src="${r.escapeHtml(e.gif_url)}" alt="GIF" class="img-fluid rounded-3 mb-2" loading="lazy">`:"",c=r.nl2br(r.escapeHtml(e.comment||"")),b=r.formatText(c);return`
            <div class="bg-theme-auto rounded-4 shadow-sm p-3 mb-3" data-uuid="${r.escapeHtml(e.uuid)}">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <p class="fw-bold m-0 p-0 text-truncate" style="font-size: 0.95rem;">
                        ${r.escapeHtml(e.name||"Anonim")} ${o}
                    </p>
                    <small class="text-secondary">${t}</small>
                </div>
                ${g}
                <p class="m-0 p-0" style="font-size: 0.9rem;">${b}</p>
                <div class="d-flex justify-content-end align-items-center mt-2">
                    <button style="font-size: 0.8rem;" onclick="undangan.admin.deleteComment('${r.escapeHtml(e.uuid)}')"
                            data-uuid="${r.escapeHtml(e.uuid)}" class="btn btn-sm btn-danger rounded-4 py-0 me-1 shadow-sm">
                        Delete
                    </button>
                    </div>
            </div>
        `},n=async(e=!1)=>{if(l.dataset.loading==="true"){console.log("Admin: Sedang memuat komentar, abaikan permintaan.");return}l.dataset.loading="true",i.disabled=!0,k.classList.remove("d-none");try{e&&(l.replaceChildren(),w=null,h=null,console.log("Admin: Mereset daftar komentar."));let t=a.orderBy("created_at","desc").limit(T);w&&(t=t.startAfter(w));let o=await t.get();if(o.empty){i.classList.add("d-none"),e&&(l.innerHTML='<p class="text-center text-secondary">Belum ada komentar.</p>'),console.log("Admin: Tidak ada komentar lagi untuk dimuat.");return}let g="";o.docs.forEach(c=>{let b=c.data(),M=N.getCommentResponse({...b,uuid:c.id});g+=x(M)}),l.insertAdjacentHTML("beforeend",g),w=o.docs[o.docs.length-1],h=o.docs[0],i.classList.remove("d-none"),o.docs.length<T&&i.classList.add("d-none"),console.log(`Admin: Berhasil memuat ${o.docs.length} komentar.`)}catch(t){console.error("Admin: Gagal memuat komentar:",t),r.notify(`Gagal memuat komentar admin: ${t.message}`).error(),i.classList.remove("d-none")}finally{l.dataset.loading="false",i.disabled=!1,k.classList.add("d-none")}},d=async()=>{try{let e=firebase.auth().currentUser;if(!e){console.warn("Admin: Tidak ada user yang sedang login saat getUserStats dipanggil."),D.clearSession();return}let t=await D.getDetailUser();if(t.code!==200)throw new Error(t.error||"Failed to get user details.");let o=t.data;r.safeInnerHTML(document.getElementById("dashboard-name"),`${r.escapeHtml(o.name||e.email)}<i class="fa-solid fa-hands text-warning ms-2"></i>`),document.getElementById("dashboard-email").textContent=o.email,document.getElementById("dashboard-accesskey").value=o.access_key||"Generate New Key",document.getElementById("button-copy-accesskey").setAttribute("data-copy",o.access_key||""),document.getElementById("form-name").value=r.escapeHtml(o.name||""),document.getElementById("form-timezone").value=o.tz||"Asia/Jakarta",document.getElementById("filterBadWord").checked=!!o.is_filter,document.getElementById("confettiAnimation").checked=!!o.is_confetti_animation,document.getElementById("replyComment").checked=!!o.can_reply,document.getElementById("editComment").checked=!!o.can_edit,document.getElementById("deleteComment").checked=!!o.can_delete,document.getElementById("dashboard-tenorkey").value=o.tenor_key||"",B("config").set("tenor_key",o.tenor_key||""),B("config").set("is_filter",o.is_filter||!1),B("config").set("is_confetti_animation",o.is_confetti_animation||!1),B("config").set("can_reply",o.can_reply||!1),B("config").set("can_edit",o.can_edit||!1),B("config").set("can_delete",o.can_delete||!1),document.dispatchEvent(new Event("undangan.session"));let g=await a.get(),c=0,b=0,M=0,L=0;g.forEach(R=>{let $=R.data();c++,b+=$.like||0,$.presence==="1"?M++:$.presence==="2"&&L++}),document.getElementById("count-comment").textContent=String(c).replace(/\B(?=(\d{3})+(?!\d))/g,"."),document.getElementById("count-like").textContent=String(b).replace(/\B(?=(\d{3})+(?!\d))/g,"."),document.getElementById("count-present").textContent=String(M).replace(/\B(?=(\d{3})+(?!\d))/g,"."),document.getElementById("count-absent").textContent=String(L).replace(/\B(?=(\d{3})+(?!\d))/g,"."),n(!0)}catch(e){console.error("Admin: Error di getUserStats:",e),r.notify(`Error memuat data dashboard: ${e.message}`).error(),D.clearSession()}},v=(e,t)=>{let o=r.disableCheckbox(e),g={[t]:e.checked};p.set(g,{merge:!0}).then(()=>{r.notify(`Pengaturan ${t} berhasil diubah.`).success(),B("config").set(t,e.checked)}).catch(c=>{console.error(`Admin: Gagal mengubah ${t}:`,c),r.notify(`Gagal mengubah pengaturan: ${c.message}`).error(),e.checked=!e.checked}).finally(()=>o.restore())},C=e=>{let t=r.disableButton(e),o=document.getElementById("dashboard-tenorkey");o.disabled=!0;let g=o.value.length?o.value:null,c={tenor_key:g};p.set(c,{merge:!0}).then(()=>{r.notify(`Berhasil ${g?"menambah":"menghapus"} Tenor Key`).success(),B("config").set("tenor_key",g),document.dispatchEvent(new Event("undangan.session"))}).catch(b=>{console.error("Admin: Gagal mengubah Tenor Key:",b),r.notify(`Gagal mengubah Tenor Key: ${b.message}`).error()}).finally(()=>{o.disabled=!1,t.restore()})},m=e=>{if(!r.ask("Apakah Anda yakin ingin meregenerasi Access Key? Key lama akan tidak berlaku."))return;let t=r.disableButton(e),o=r.generateUUID(),g={access_key:o};p.set(g,{merge:!0}).then(()=>{document.getElementById("dashboard-accesskey").value=o,document.getElementById("button-copy-accesskey").setAttribute("data-copy",o),r.notify("Access Key baru berhasil digenerasi!").success()}).catch(c=>{console.error("Admin: Gagal meregenerasi Access Key:",c),r.notify(`Gagal meregenerasi Access Key: ${c.message}`).error()}).finally(()=>t.restore())},f=async e=>{let t=document.getElementById("old_password"),o=document.getElementById("new_password");if(t.value.length===0||o.value.length===0){r.notify("Password tidak boleh kosong.").warning();return}t.disabled=!0,o.disabled=!0;let g=r.disableButton(e);try{let c=firebase.auth().currentUser;if(!c)throw new Error("Tidak ada user yang sedang login.");let b=firebase.auth.EmailAuthProvider.credential(c.email,t.value);await c.reauthenticateWithCredential(b),await c.updatePassword(o.value),t.value="",o.value="",r.notify("Password berhasil diubah!").success()}catch(c){console.error("Admin: Gagal mengubah password:",c);let b="Gagal mengubah password.";c.code==="auth/wrong-password"?b="Password lama salah.":c.code==="auth/requires-recent-login"&&(b="Sesi Anda sudah terlalu lama, harap logout dan login kembali untuk mengubah password."),r.notify(`${b} ${c.message}`).error()}finally{g.restore(!0),t.disabled=!1,o.disabled=!1}},A=e=>{let t=document.getElementById("form-name");if(t.value.length===0){r.notify("Nama tidak boleh kosong.").warning();return}t.disabled=!0;let o=r.disableButton(e),g=t.value,c=firebase.auth().currentUser;if(!c){r.notify("Tidak ada user yang sedang login.").error(),o.restore(),t.disabled=!1;return}Promise.all([c.updateProfile({displayName:g}),p.set({name:g},{merge:!0})]).then(()=>{r.safeInnerHTML(document.getElementById("dashboard-name"),`${r.escapeHtml(g)}<i class="fa-solid fa-hands text-warning ms-2"></i>`),r.notify("Nama berhasil diubah!").success();let b=D.getUserStorage();b&&b.set("name",g)}).catch(b=>{console.error("Admin: Gagal mengubah nama:",b),r.notify(`Gagal mengubah nama: ${b.message}`).error()}).finally(()=>{t.disabled=!1,o.restore(!0)})},S=async e=>{let t=r.disableButton(e);try{let o=await a.orderBy("created_at","asc").get();if(o.empty){r.notify("Tidak ada komentar untuk diunduh.").info();return}let g=`Nama,Presensi,Komentar,GIF URL,IP,User Agent,Waktu,Like
`;o.forEach(M=>{let L=M.data(),R=`"${(L.name||"").replace(/"/g,'""')}"`,$=L.presence==="1"?"Datang":L.presence==="2"?"Berhalangan":"Tidak Diketahui",P=`"${(L.commentText||"").replace(/"/g,'""')}"`,q=L.gif||"",ee=L.ip||"",te=L.user_agent||"",ne=L.created_at?.toDate().toLocaleString("id-ID")||"",oe=L.like||0;g+=`${R},${$},${P},${q},${ee},${te},${ne},${oe}
`});let c=new Blob([g],{type:"text/csv;charset=utf-8;"}),b=document.createElement("a");if(b.download!==void 0){let M=URL.createObjectURL(c);b.setAttribute("href",M),b.setAttribute("download","comments.csv"),b.style.visibility="hidden",document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(M),r.notify("Data komentar berhasil diunduh.").success()}else r.notify("Browser Anda tidak mendukung pengunduhan file.").error()}catch(o){console.error("Admin: Gagal mengunduh komentar:",o),r.notify(`Gagal mengunduh komentar: ${o.message}`).error()}finally{t.restore()}},y=()=>{let e=document.getElementById("button-change-name"),t=document.getElementById("form-name");e&&(e.disabled=t.value.length===0)},I=()=>{let e=document.getElementById("button-change-password"),t=document.getElementById("old_password");e&&(e.disabled=t.value.length===0)},_=(e,t=null)=>{let o=Intl.supportedValuesOf("timeZone"),g=document.getElementById("dropdown-tz-list");e.value&&e.value.trim().length>0&&(o=o.filter(c=>c.toLowerCase().includes(e.value.trim().toLowerCase()))),t===null&&document.addEventListener("click",c=>{if(!e.contains(c.target)&&!g.contains(c.target)){if(e.value.trim().length<=0){e.setCustomValidity("Timezone cannot be empty."),e.reportValidity();return}e.setCustomValidity(""),g.classList.add("d-none")}},{once:!0,capture:!0}),g.replaceChildren(),g.classList.remove("d-none"),o.slice(0,20).forEach(c=>{let b=document.createElement("button");b.type="button",b.className="list-group-item list-group-item-action py-1 small",b.textContent=`${c} (${r.getGMTOffset(c)})`,b.onclick=()=>{e.value=c,g.classList.add("d-none"),document.getElementById("button-timezone").disabled=!1},g.appendChild(b)})},U=e=>{let t=document.getElementById("form-timezone");if(t.value.length===0){r.notify("Zona waktu tidak boleh kosong.").warning();return}if(!Intl.supportedValuesOf("timeZone").includes(t.value)){r.notify("Zona waktu tidak didukung.").warning();return}t.disabled=!0;let o=r.disableButton(e),c={tz:t.value};p.update(c).then(()=>{r.notify("Zona waktu berhasil diubah!").success()}).catch(b=>{console.error("Admin: Gagal mengubah zona waktu:",b),r.notify(`Gagal mengubah zona waktu: ${b.message}`).error()}).finally(()=>{t.disabled=!1,o.restore(!0)})},O=async e=>{if(!r.ask("Apakah Anda yakin ingin menghapus komentar ini dan semua balasannya?"))return;let t=document.querySelector(`button[onclick*="deleteComment('${e}')"]`),o=t?t.innerHTML:"";t&&(t.disabled=!0,t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Hapus...');try{let g=async L=>{let R=await a.where("parentId","==",L).get(),$=[];for(let P of R.docs){$.push(P.id);let q=await g(P.id);$=$.concat(q)}return $},c=[e],b=await g(e);c.push(...b);let M=db.batch();c.forEach(L=>{let R=a.doc(L);M.delete(R)}),await M.commit(),r.notify("Komentar dan semua balasannya berhasil dihapus!").success(),c.forEach(L=>{let R=document.querySelector(`#admin-comments-list [data-uuid="${L}"]`);R&&R.remove()}),await d()}catch(g){console.error("Admin: Gagal menghapus komentar:",g),r.notify(`Gagal menghapus komentar: ${g.message}`).error()}finally{t&&(t.disabled=!1,t.innerHTML=o)}},s=()=>{z.init(),z.setDefault("en"),Y.init(),F.spyTop(),l=document.getElementById("admin-comments-list"),i=document.getElementById("load-more-admin-button"),k=i.querySelector(".fa-spinner"),i.addEventListener("click",()=>n(!1)),document.addEventListener("hidden.bs.modal",d,{once:!0}),firebase.auth().onAuthStateChanged(e=>{e?(console.log("Admin: User sudah login Firebase Auth, UID:",e.uid),d(),setTimeout(()=>{typeof window.bootstrap<"u"&&typeof window.bootstrap.Modal<"u"?window.bootstrap.Modal.getOrCreateInstance(document.getElementById("mainModal")).hide():console.error("DEBUG: window.bootstrap.Modal tidak tersedia saat mencoba hide modal setelah login.")},100)):(console.log("Admin: User belum login Firebase Auth. Menampilkan modal login."),setTimeout(()=>{typeof window.bootstrap<"u"&&typeof window.bootstrap.Modal<"u"?(console.log("Admin: Memanggil window.bootstrap.Modal().show() setelah penundaan."),window.bootstrap.Modal.getOrCreateInstance(document.getElementById("mainModal")).show()):console.error("ERROR: window.bootstrap.Modal masih tidak didefinisikan setelah penundaan. Ada masalah fundamental.")},100))})};return{init:()=>(D.init(),F.init(),X.init(),a=db.collection("comments"),document.addEventListener("DOMContentLoaded",s),{util:r,theme:F,admin:{auth:D,navbar:j,logout:E,tenor:C,download:S,regenerate:m,changeName:A,changePassword:f,changeCheckboxValue:v,enableButtonName:y,enableButtonPassword:I,openLists:_,changeTz:U,deleteComment:O,loadAdminComments:n}})}})();(a=>{a.undangan=Q.init()})(window);})();
